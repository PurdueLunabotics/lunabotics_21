<?xml version="1.0"?>
<launch>
  <arg name="serial_no_d455_back" default="053122251286" />
  <arg name="serial_no_d455_front" default="053122251335" />
  <arg name="initial_reset" default="true" />
  <arg name="sim" default="false" />
  <arg name="width" default="640" />
  <arg name="height" default="480" />
  <arg name="fps" default="60" />
  <arg name="front" default="true" />
  <arg name="back" default="true" />

  <group unless="$(arg sim)">

    <!-- IMU -->
    <node name="imu" pkg="lunabot_perception" type="imu_node" output="screen">
      <param name="imu_frame_id" type="string" value="d455_back" />
      <param name="topic_name" type="string" value="/imu" />
    </node>

    <!-- Static Transforms for both realsense cameras -->
    <node pkg="tf" type="static_transform_publisher" name="base_to_camera1_tf"
      args="0 0 0 0 0 0 /odom /camera1_link 100" />
    <node pkg="tf" type="static_transform_publisher" name="base_to_camera2_tf"
      args="-0.9144 -0.3556 0.127 3.1415926 0.0 0.0 /odom /camera2_link 100" />

    <group ns="d455_front" if="$(arg front)">
      <include file="$(find realsense2_camera)/launch/rs_camera.launch">
        <arg name="serial_no" value="$(arg serial_no_d455_front)" />
        <arg name="tf_prefix" value="d455_front" />
        <arg name="filters" value="disparity,decimation" />
        <arg name="align_depth" value="true" />
        <arg name="initial_reset" value="$(arg initial_reset)" />
        <arg name="depth_width" value="$(arg width)" />
        <arg name="depth_height" value="$(arg height)" />
        <arg name="depth_fps" value="$(arg fps)" />
        <arg name="color_width" value="$(arg width)" />
        <arg name="color_height" value="$(arg height)" />
        <arg name="color_fps" value="$(arg fps)" />
        <arg name="enable_gyro" value="false" />
        <arg name="enable_accel" value="false" />
        <arg name="enable_sync" value="true" />

      </include>

      <group ns="camera/color">
        <node pkg="image_proc" type="image_proc" name="image_proc"
          args="image:=camera/color/image_raw" />
        <include file="$(find lunabot_perception)/launch/apriltag.launch">
          <arg name="camera_frame" value="d455_front_base" />
        </include>
      </group>

      <!-- sync rgb/depth images per camera -->
      <node pkg="nodelet" type="nodelet" name="rgbd_sync" args="standalone rtabmap_sync/rgbd_sync"
        output="screen">
        <remap from="rgb/image" to="camera/color/image_rect_color" />
        <remap from="depth/image" to="camera/depth/image_rect_raw" />
        <remap from="rgb/camera_info" to="camera/color/camera_info" />
        <param name="approx_sync" value="false" />
      </node>
    </group>

    <group ns="d455_back" if="$(arg back)">
      <include file="$(find realsense2_camera)/launch/rs_camera.launch">
        <arg name="serial_no" value="$(arg serial_no_d455_back)" />
        <arg name="tf_prefix" value="d455_back" />
        <arg name="filters" value="disparity,decimation" />
        <arg name="align_depth" value="true" />
        <arg name="initial_reset" value="$(arg initial_reset)" />
        <arg name="depth_width" value="$(arg width)" />
        <arg name="depth_height" value="$(arg height)" />
        <arg name="depth_fps" value="$(arg fps)" />
        <arg name="color_width" value="$(arg width)" />
        <arg name="color_height" value="$(arg height)" />
        <arg name="color_fps" value="$(arg fps)" />
        <arg name="enable_gyro" value="false" />
        <arg name="enable_accel" value="false" />
        <arg name="enable_sync" value="true" />

      </include>

      <group ns="camera/color">
        <node pkg="image_proc" type="image_proc" name="image_proc"
          args="image:=camera/color/image_raw" />
        <include file="$(find lunabot_perception)/launch/apriltag.launch">
          <arg name="camera_frame" value="d455_back_base" />
        </include>
      </group>

      <!-- sync rgb/depth images per camera -->
      <node pkg="nodelet" type="nodelet" name="rgbd_sync" args="standalone rtabmap_sync/rgbd_sync"
        output="screen">
        <remap from="rgb/image" to="camera/color/image_rect_color" />
        <remap from="depth/image" to="camera/depth/image_rect_raw" />
        <remap from="rgb/camera_info" to="camera/color/camera_info" />
        <param name="approx_sync" value="false" />
      </node>
    </group>


  </group>

  <group if="$(arg sim)">
    <group ns="d435_forward/color" if="$(arg front)">
      <node pkg="image_proc" type="image_proc" name="image_proc" />
      <include file="$(find lunabot_perception)/launch/apriltag.launch">
        <arg name="camera_frame" value="d435_forward_link" />
      </include>
    </group>

    <group ns="d435_backward/color" if="$(arg back)">
      <node pkg="image_proc" type="image_proc" name="image_proc" />
      <include file="$(find lunabot_perception)/launch/apriltag.launch">
        <arg name="camera_frame" value="d435_backward_link" />
      </include>
    </group>
  </group>
</launch>